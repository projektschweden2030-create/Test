name: Bootstrap Team Task Board
on:
  workflow_dispatch:
    inputs:
      project_name:
        description: Name of the project board
        default: Team Task Board
        required: true

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      projects: write

    steps:
      - name: Checkout (nur Kontext, wir committen per API)
        uses: actions/checkout@v4

      - name: Create repo files + labels + issues
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const projectName = core.getInput('project_name');

            async function upsert(path, content, message) {
              let sha = undefined;
              try {
                const { data } = await github.repos.getContent({ owner, repo, path });
                sha = data.sha;
              } catch (_) {}
              await github.repos.createOrUpdateFileContents({
                owner, repo, path,
                message,
                content: Buffer.from(content, 'utf8').toString('base64'),
                sha
              });
            }

            // README
            await upsert(
              'README.md',
              `# ${projectName}\n\nAuto-setup via GitHub Actions.\n\n- Project Board: created\n- Issue Template: added\n- Sample stories: created\n`,
              'chore: add README'
            );

            // Issue Template
            await upsert(
              '.github/ISSUE_TEMPLATE/user_story.md',
              `---\nname: User Story\ndescription: Create a user story\nlabels: story\n---\n\nAs a <role>, I need <feature>, so that <benefit>.\n\n**Acceptance Criteria**\n- Given ... When ... Then ...\n\n**Notes**\n- Non-functional / Risks / Dependencies\n`,
              'chore: add user story template'
            );

            // Labels
            const labels = [
              { name: 'story', color: '1f6feb', description: 'User story' },
              { name: 'blocked', color: 'd73a4a', description: 'Blocked item' }
            ];
            for (const l of labels) {
              try { await github.issues.createLabel({ owner, repo, ...l }); } catch (_) {}
            }

            // Sample issues
            const titles = [
              'Story 1: Signup flow',
              'Story 2: Login screen',
              'Story 3: Profile page',
              'Story 4: Notifications',
              'Story 5: Data export'
            ];
            for (const t of titles) {
              await github.issues.create({ owner, repo, title: t, labels: ['story'] });
            }

      - name: Create classic project + columns + add issues
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const projectName = core.getInput('project_name');

            // Create classic project (Inertia preview)
            const { data: project } = await github.request(
              'POST /repos/{owner}/{repo}/projects',
              { owner, repo, name: projectName, mediaType: { previews: ['inertia'] } }
            );

            // Columns
            const colNames = ['Product Backlog', 'Sprint Backlog', 'In Progress', 'Done', 'Blocked'];
            const cols = {};
            for (const name of colNames) {
              const { data: col } = await github.request(
                'POST /projects/{project_id}/columns',
                { project_id: project.id, name, mediaType: { previews: ['inertia'] } }
              );
              cols[name] = col.id;
            }

            // Fetch last 10 issues
            const { data: issues } = await github.issues.listForRepo({ owner, repo, per_page: 10, state: 'open' });

            // Put first 3 into Sprint Backlog, others in Product Backlog
            for (let i = 0; i < issues.length; i++) {
              const issue = issues[i];
              const column_id = i < 3 ? cols['Sprint Backlog'] : cols['Product Backlog'];
              await github.request(
                'POST /projects/columns/{column_id}/cards',
                {
                  column_id,
                  content_id: issue.id,
                  content_type: 'Issue',
                  mediaType: { previews: ['inertia'] }
                }
              );
              // First two also into In Progress (duplicate card is allowed in classic projects as a note card linking the issue)
              if (i < 2) {
                await github.request(
                  'POST /projects/columns/{column_id}/cards',
                  {
                    column_id: cols['In Progress'],
                    content_id: issue.id,
                    content_type: 'Issue',
                    mediaType: { previews: ['inertia'] }
                  }
                );
              }
            }

      - name: Output links
        run: |
          echo "Repo: https://github.com/${{ github.repository }}"
          echo "Project boards (classic): https://github.com/${{ github.repository }}/projects"
