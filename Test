#!/usr/bin/env bash
# full_github_agile_board_setup.sh
# Builds a complete agile "Team Task Board" setup via code only.

set -euo pipefail

########################
# >>> EDIT THIS <<<
########################
GITHUB_USER="projektschweden2030-create"   # Dein GitHub-User
REPO_NAME="Test"                           # Dein Ziel-Repo (muss existieren, public)
REPO_URL="https://github.com/${GITHUB_USER}/${REPO_NAME}.git"

PROJECT_TITLE="Team Task Board"
PROJECT_DESC="Kanban: Product Backlog | Sprint Backlog | In Progress | Review | Done"
SPRINT_NAME="Sprint 1 – MVP Delivery"

########################
# Helpers
########################
ensure_label () {
  local NAME="$1" COLOR="$2"
  gh label create "$NAME" --color "$COLOR" --repo "${GITHUB_USER}/${REPO_NAME}" >/dev/null 2>&1 || \
  gh label edit "$NAME" --color "$COLOR" --repo "${GITHUB_USER}/${REPO_NAME}" >/dev/null
}

issue_url_by_title () {
  local TITLE="$1"
  gh issue list --repo "${GITHUB_USER}/${REPO_NAME}" --limit 200 --json title,url \
    | jq -r ".[] | select(.title==\"$TITLE\") | .url"
}

########################
# 1) Create minimal repo content (in-memory via heredocs)
########################
TMPDIR=$(mktemp -d)
cd "$TMPDIR"
git init

# README
cat > README.md <<'MD'
# Team Task Board (Autogenerated)

Dieses Repository wurde per Script erstellt. Es enthält:
- GitHub Issue-Template **User Story**
- Labels für Typ/Prio/Story Points
- Projektboard (*Projects*) mit Spalten: Product Backlog | Sprint Backlog | In Progress | Review | Done
- Beispiel-Stories als Issues (Story 1–5), davon #1–#2 **In Progress**, #3 **Sprint Backlog**

## Burn-Down (Beispiel, statisch)
Siehe `burndown/example_burndown.svg` – als Screenshot für die Abgabe nutzbar.
MD

# Issue Template
mkdir -p .github/ISSUE_TEMPLATE
cat > .github/ISSUE_TEMPLATE/user_story.md <<'YML'
---
name: User Story
about: As a <role>, I want <capability>, so that <value>
title: "Story: "
labels: ["type:feature","status:backlog"]
assignees: []
---

## Story
As a **<role>**, I want **<capability>**, so that **<value>**.

## Acceptance Criteria (Gherkin)
- Given …
- When …
- Then …

## Notes
- Story Points: <1|2|3|5|8>
- Risks / Dependencies:
YML

# Statisches Burn-Down (SVG)
mkdir -p burndown
cat > burndown/example_burndown.svg <<'SVG'
<svg width="640" height="360" xmlns="http://www.w3.org/2000/svg">
  <rect width="640" height="360" fill="#ffffff"/>
  <text x="20" y="30" font-family="Arial" font-size="18">Sprint 1 Burn-Down (Demo)</text>
  <!-- axes -->
  <line x1="60" y1="300" x2="600" y2="300" stroke="#000"/>
  <line x1="60" y1="60"  x2="60"  y2="300" stroke="#000"/>
  <!-- ideal line -->
  <polyline points="60,80 600,300" fill="none" stroke="#999" stroke-dasharray="6,4"/>
  <!-- actual -->
  <polyline points="60,90 140,130 220,170 300,205 380,235 460,260 540,280 600,290"
            fill="none" stroke="#0070f3" stroke-width="2"/>
  <!-- ticks -->
  <text x="55" y="320" font-size="12">D1</text>
  <text x="135" y="320" font-size="12">D2</text>
  <text x="215" y="320" font-size="12">D3</text>
  <text x="295" y="320" font-size="12">D4</text>
  <text x="375" y="320" font-size="12">D5</text>
  <text x="455" y="320" font-size="12">D6</text>
  <text x="535" y="320" font-size="12">D7</text>
  <text x="590" y="320" font-size="12">D8</text>
  <text x="10" y="85" font-size="12">SP</text>
</svg>
SVG

git add .
git commit -m "bootstrap: README, issue template, demo burndown"
git branch -M main
git remote add origin "$REPO_URL"
git push -u origin main

########################
# 2) Labels
########################
ensure_label "type:feature" "3E4B9E"
ensure_label "technical-debt" "B60205"
ensure_label "priority:high" "D93F0B"
ensure_label "priority:medium" "FBCA04"
ensure_label "status:backlog" "BFD4F2"
for sp in 1 2 3 5 8; do ensure_label "story-points:${sp}" "0E8A16"; done

########################
# 3) Create USER project (Projects Beta) with fields
########################
# create if missing
if ! gh project list --owner "$GITHUB_USER" --format json | jq -e ".[] | select(.title==\"$PROJECT_TITLE\")" >/dev/null; then
  gh project create "$PROJECT_TITLE" --owner "$GITHUB_USER" --title "$PROJECT_TITLE" --description "$PROJECT_DESC" >/dev/null
fi
PROJECT_ID=$(gh project list --owner "$GITHUB_USER" --format json | jq -r ".[] | select(.title==\"$PROJECT_TITLE\") | .id")

# Status field (columns)
STATUS_FIELD_ID=$(gh project field-list "$PROJECT_ID" --owner "$GITHUB_USER" --format json | jq -r '.[] | select(.name=="Status") | .id' || true)
if [ -z "${STATUS_FIELD_ID:-}" ] || [ "$STATUS_FIELD_ID" = "null" ]; then
  gh project field-create "$PROJECT_ID" --owner "$GITHUB_USER" --name "Status" --data-type SINGLE_SELECT \
    --single-select-options "Product Backlog,Sprint Backlog,In Progress,Review,Done" >/dev/null
  STATUS_FIELD_ID=$(gh project field-list "$PROJECT_ID" --owner "$GITHUB_USER" --format json | jq -r '.[] | select(.name=="Status") | .id')
fi

# Story Points (number)
POINTS_FIELD_ID=$(gh project field-list "$PROJECT_ID" --owner "$GITHUB_USER" --format json | jq -r '.[] | select(.name=="Story Points") | .id' || true)
if [ -z "${POINTS_FIELD_ID:-}" ] || [ "$POINTS_FIELD_ID" = "null" ]; then
  gh project field-create "$PROJECT_ID" --owner "$GITHUB_USER" --name "Story Points" --data-type NUMBER >/dev/null
  POINTS_FIELD_ID=$(gh project field-list "$PROJECT_ID" --owner "$GITHUB_USER" --format json | jq -r '.[] | select(.name=="Story Points") | .id')
fi

# Sprint (text)
SPRINT_FIELD_ID=$(gh project field-list "$PROJECT_ID" --owner "$GITHUB_USER" --format json | jq -r '.[] | select(.name=="Sprint") | .id' || true)
if [ -z "${SPRINT_FIELD_ID:-}" ] || [ "$SPRINT_FIELD_ID" = "null" ]; then
  gh project field-create "$PROJECT_ID" --owner "$GITHUB_USER" --name "Sprint" --data-type TEXT >/dev/null
  SPRINT_FIELD_ID=$(gh project field-list "$PROJECT_ID" --owner "$GITHUB_USER" --format json | jq -r '.[] | select(.name=="Sprint") | .id')
fi

########################
# 4) Create Stories (as Issues) – pure code
########################
make_story () {
  local TITLE="$1" POINTS="$2" BODY="$3" LABELS="$4"
  local ARGS=()
  IFS=',' read -r -a arr <<< "$LABELS"
  for L in "${arr[@]}"; do
    ensure_label "$L" "CCCCCC"
    ARGS+=( -l "$L" )
  done
  gh issue create --repo "${GITHUB_USER}/${REPO_NAME}" \
    -t "$TITLE" -b "$BODY" "${ARGS[@]}" >/dev/null
}

make_story "Story 1: Aufgaben erstellen" 3 \
"As a PM, I want to create tasks from the backlog, so that work is ready for execution.

**AC (Gherkin)**
- Given a backlog item exists
- When I convert it to a task
- Then it appears in Sprint Backlog

Story Points: 3" \
"type:feature,status:backlog,story-points:3,priority:high"

make_story "Story 2: Aufgaben priorisieren" 2 \
"As a PM, I want to prioritize tasks, so that the team pulls the most valuable work first.

AC:
- Given tasks in backlog
- When I set priority
- Then board shows the order

Story Points: 2" \
"type:feature,status:backlog,story-points:2,priority:medium"

make_story "Story 3: Team-Zuweisung" 2 \
"As a PM, I want to assign tasks to team members, so that ownership is clear.

AC:
- Given an unassigned task
- When I assign a member
- Then it shows the assignee

Story Points: 2" \
"type:feature,status:backlog,story-points:2"

make_story "Story 4: Review & Definition of Done" 5 \
"As a PM, I want a Review step, so that quality is verifiable.

AC:
- Given a task in progress
- When acceptance criteria are met
- Then item moves to Review

Story Points: 5" \
"type:feature,status:backlog,story-points:5"

make_story "Story 5: Technische Schulden aufräumen" 3 \
"As a dev, I want to pay down technical debt, so that maintainability improves.

AC:
- Given legacy modules
- When refactoring is done
- Then complexity score decreases

Story Points: 3" \
"technical-debt,status:backlog,story-points:3"

########################
# 5) Add issues to project, set fields, move columns
########################
add_to_project () {
  local ISSUE_URL="$1"
  gh project item-add "$PROJECT_ID" --owner "$GITHUB_USER" --url "$ISSUE_URL" --format json | jq -r '.id'
}

set_status () {
  local ITEM_ID="$1" STATUS_VAL="$2"
  gh project item-edit "$PROJECT_ID" --owner "$GITHUB_USER" --id "$ITEM_ID" \
     --field-id "$STATUS_FIELD_ID" --single-select-option "$STATUS_VAL" >/dev/null
}

set_points () {
  local ITEM_ID="$1" POINTS="$2"
  gh project item-edit "$PROJECT_ID" --owner "$GITHUB_USER" --id "$ITEM_ID" \
     --field-id "$POINTS_FIELD_ID" --number "$POINTS" >/dev/null
}

set_sprint () {
  local ITEM_ID="$1"
  gh project item-edit "$PROJECT_ID" --owner "$GITHUB_USER" --id "$ITEM_ID" \
     --field-id "$SPRINT_FIELD_ID" --text "$SPRINT_NAME" >/dev/null
}

declare -A STORY_POINTS=(
  ["Story 1: Aufgaben erstellen"]=3
  ["Story 2: Aufgaben priorisieren"]=2
  ["Story 3: Team-Zuweisung"]=2
  ["Story 4: Review & Definition of Done"]=5
  ["Story 5: Technische Schulden aufräumen"]=3
)

for TITLE in "${!STORY_POINTS[@]}"; do
  URL=$(issue_url_by_title "$TITLE")
  [ -z "$URL" ] && { echo "Issue not found: $TITLE"; exit 1; }
  ITEM_ID=$(add_to_project "$URL")
  set_status "$ITEM_ID" "Product Backlog"
  set_points "$ITEM_ID" "${STORY_POINTS[$TITLE]}"
done

# Sprint-Zuordnung: Story 1–3 -> Sprint Backlog; 1–2 -> In Progress
for TITLE in "Story 1: Aufgaben erstellen" "Story 2: Aufgaben priorisieren" "Story 3: Team-Zuweisung"; do
  URL=$(issue_url_by_title "$TITLE")
  ITEM_ID=$(gh project item-list "$PROJECT_ID" --owner "$GITHUB_USER" --format json | jq -r ".[] | select(.content.url==\"$URL\") | .id")
  set_sprint "$ITEM_ID"
  set_status "$ITEM_ID" "Sprint Backlog"
done

for TITLE in "Story 1: Aufgaben erstellen" "Story 2: Aufgaben priorisieren"; do
  URL=$(issue_url_by_title "$TITLE")
  ITEM_ID=$(gh project item-list "$PROJECT_ID" --owner "$GITHUB_USER" --format json | jq -r ".[] | select(.content.url==\"$URL\") | .id")
  set_status "$ITEM_ID" "In Progress"
done

echo "✅ Fertig: Repo-Inhalte, Labels, Project-Board, Stories & Moves gesetzt."
echo "➡️ Board: https://github.com/users/${GITHUB_USER}/projects"
echo "➡️ Repo : ${REPO_URL}"
